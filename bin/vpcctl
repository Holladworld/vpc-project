#!/bin/bash
# Main VPC CLI - Entry point for the VPC management system

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Import libraries
source "$PROJECT_ROOT/lib/vpc_core.sh"
source "$PROJECT_ROOT/lib/subnet_manager.sh" 
source "$PROJECT_ROOT/lib/firewall.sh"
source "$PROJECT_ROOT/lib/peering.sh"
source "$PROJECT_ROOT/lib/nat_gateway.sh"
source "$PROJECT_ROOT/config/defaults.sh"

# Main dispatcher
main() {
    case "$1" in
        create-vpc)        create_vpc "$2" "$3" ;;
        delete-vpc)        delete_vpc "$2" ;;
        add-subnet)        add_subnet "$2" "$3" "$4" ;;
        enable-nat)        enable_nat "$2" ;;
        create-peering)    create_peering "$2" "$3" ;;
        delete-peering)    delete_peering "$2" "$3" ;;
        list-peerings)     list_peerings ;;
        apply-firewall)    apply_firewall "$2" "$3" ;;
        test-connectivity) test_connectivity "$2" ;;
        test-isolation)    test_isolation "$2" "$3" ;;
        deploy-app)        deploy_app "$2" "$3" "$4" ;;
        run-tests)         run_tests ;;
        cleanup-all)       "$SCRIPT_DIR/cleanup-all" ;;  # Call the cleanup script
        list-vpcs)         list_vpcs ;;
        list-subnets)      list_subnets ;;  
        *)                 show_usage ;;
    esac
}

show_usage() {
    echo "VPC Management System"
    echo "Usage: $0 {create-vpc|delete-vpc|add-subnet|enable-nat|create-peering|delete-peering|list-peerings|apply-firewall|test-connectivity|test-isolation|deploy-app|run-tests|cleanup-all|list-vpcs|list-subnets}"
    echo ""
    echo "Examples:"
    echo "  sudo $0 create-vpc prod-vpc 10.0.0.0/16"
    echo "  sudo $0 add-subnet prod-vpc public 10.0.1.0/24"
    echo "  sudo $0 apply-firewall prod-vpc firewall_rules.json"
    echo "  sudo $0 deploy-app prod-vpc public nginx"
    echo "  sudo $0 run-tests                          # Run all acceptance tests"
    echo "  sudo $0 cleanup-all                        # Remove all VPC resources"
}

if [ $# -eq 0 ]; then
    show_usage
else
    main "$@"
fi
